# PersonalTracker.Api

## Introduction

PersonalTracker.Api is a reference implementation of using microservices with a browser based application. It currently has two services, each backed by a database.

* The Pomodoro.Api service manages a logs of time blocks of the user.
* The IdServer manages authentication and authorization.

In addition to these there are containers which only exist in development.

* LocalProxy, serves static pages, and makes all requests to look like they are served from the same machine. In production, this will be replaced by a Storage Bucket with CDN for static pages, and a Kubernetes Service for the routing.
* pgsql, hosts a local postgresql database. In production, this would be replaced by a hosted database
* pgadmin4, is a web-based sql explorer for postgresql. It is pulled directly from dockerhub.

All containers are connected via one bridged docker network, pomodoro-net

During run, source code directories are mapped via docker volumes

Here are some URLS to use as sanity checks

* http://localhost/index.html - Is the proxy/static server running?
* http://localhost:2002/.well-known/openid-configuration - Is IdServer running?
* http://localhost/.well-known/openid-configuration - Can the proxy access IdServer?
* http://localhost:2003/api/ping - Is the api server running?
* http://localhost/api/ping - Can the proxy acccess the api server?
* http://localhost/testclient.html - Use debug tools to see if this calls id and api.

The proxy has been changed. The above testclient and index won't work. To get them to work remove the last line of LocalProxy/conf/proxy.conf

* http://localhost:3000 - The react app running on the local system
* http://localhost - Proxy of the react app running on the local system

Ports used in this project

* 2002 - id server
* 2003 - pomodoro api 
* 2004 - ping api 

### Local Proxy Server

LocalProxy/conf/proxy.conf defines the forwarding rules in the proxy

## Setup

Set a local environment variable POMODORO_REPOS to the folder containing your Pomodoro Repos 

    $env:POMODORO_REPOS= "{0}/Repos" -f (ls -d ~)

### Seting up dotnet core applications
Instructions for creating dotnet apps can be found at:
[aspnetcore-2.1](https://docs.microsoft.com/en-us/aspnet/core/tutorials/web-api-vsc?view=aspnetcore-2.1)

    dotnet new webapi -o Pomodoro.Api

    dotnet ef migrations add InitialMigration

    dotnet ef database update

### Setup remote debugging

Remote debugging requires the source on the server to be in sync with the source in the editor. We are going to use docker volumes to achieve this. This should work for both docker and minikube. We do not want to map our binaries because they will get locked by the server which will prevent us from building on the client. This can cause the IDE to have problems finding dependencies. Move everything which requires editing to a subfolder called src. 

In addition, we want to plan for the future for configuration files. We create two folders for this purpose. One to house general configuration, and another for secret configuration. This will allow us to inject these values from our orchastrator (Kubernetes) down the line. 

* [Installing vsdbg on the server](https://github.com/OmniSharp/omnisharp-vscode/wiki/Attaching-to-remote-processes#installing-vsdbg-on-the-server)
* [Configuring Docker attach with launch.json](https://github.com/OmniSharp/omnisharp-vscode/wiki/Attaching-to-remote-processes#configuring-docker-attach-with-launchjson)
* Move your source code (Controllers, models, etc) to a subfolder called source
* * Do include folders
* * Do include Program.cs, Startups.cs, etc
* * Do not include \*.csproj
* * Do not include autogenerated files like ef Migrate folder
* In Dockerfile, copy the root folder to appropriate like /app
* In launch commands, map your source folder to the docker container. 
* * Map 'src' folder
* * Map 'wwwroot' folder
* Map the configuration and secrets
* * config
* * secrets

# Running

* Setup infrastructure
* Take inventory
* Build
* Run containers

### Setting up the docker infrastrucutre

This infrastructure section contains common commands for these containers
* Pomodoro Postgresql Database
* pgadmin4
* Local reverse proxy
.

    # Create the volume for the database
    docker volume create pomo-pgsql-volume

    # Remove the volume for the database
    docker volume rm pomo-pgsql-volume

    # Create the network
    docker network create --driver bridge pomodoro-net
  
    # Build the pgsql database
    docker build -t pomodoro-pgsql -f pgsql/Dockerfile ./pgsql

    # run the database container
    # https://hub.docker.com/_/postgres/
    clear
    docker run `
      --name pomo-pgsql `
      --mount source=pomo-pgsql-volume,target=/var/lib/postgresql/data/pgdata `
      --network pomodoro-net `
      --rm `
      -p 5432:5432 `
      -e POSTGRES_PASSWORD=Password1 `
      -e POSTGRES_USER=samplesam `
      -e POSTGRES_DB=defaultdb `
      -e PGDATA=/var/lib/postgresql/data/pgdata `
      -d `
      pomodoro-pgsql

    # run bash in the database container
    docker exec -it pomo-pgsql bash

    # While logged into database container
    psql --username "$POSTGRES_USER" --dbname "$POSTGRES_DB"

    # Use pgadmin to explore the database
    docker run `
      -p 5002:80 `
      --rm `
      --name pomo-pgadmin `
      --network pomodoro-net `
      -e "PGADMIN_DEFAULT_EMAIL=user@domain.com" `
      -e "PGADMIN_DEFAULT_PASSWORD=Password1" `
      -d `
      dpage/pgadmin4

    # Create and run the reverse proxy
    #
    docker build -t myrevprox -f LocalProxy/Dockerfile ./LocalProxy

    #
    # Get the IP of the localmachine
    #
    $regex=[regex] '\d+\.\d+\.\d+\.\d+'
    $interface=ip -family inet -o addr show docker0
    $hostip=$regex.Match($interface).Value.Trim()
    $addhost="{0}:{1}" -f  "localmachine", $hostip
    #
    # Run the docker image
    #
    docker run `
      --name pomodoro-reverse-proxy `
      --network pomodoro-net `
      --add-host $addhost `
      -d `
      --rm `
      -p 80:80 `
      -v ~/Repos/psgivens/PersonalTracker.Api/LocalProxy/app/:/app/ `
      -v ~/Repos/psgivens/PersonalTracker.Api/LocalProxy/conf/:/conf/ `
      myrevprox 
    
    docker exec -it pomodoro-reverse-proxy apache2ctl restart

    docker exec -it pomodoro-reverse-proxy /bin/bash

    docker container stop pomodoro-reverse-proxy 

### Take inventory
    clear
    docker network list | grep -E "NAME|pomodoro"
    docker volume list | grep -E "NAME|pomodoro"
    docker container list -a | grep -E "NAMES|rapi|pgadmin|pomo|dbg"

    docker image list

### Build the application containers

    docker build -t pomodoro-dotnet-stage -f tools/dotnet.stage.Dockerfile tools

    docker build -t pomodoro-rapi -f Pomodoro.Api/Dockerfile Pomodoro.Api

    docker build -t pomodoro-ping-rapi -f Ping.Api/watch.Dockerfile Ping.Api

    docker build -t pomodoro-watch-rapi -f Pomodoro.Api/watch.Dockerfile Pomodoro.Api

    docker build -t pomodoro-idserver -f IdServer/watch.Dockerfile IdServer

### Run the application containers

Here are commands for these containers

* pomo-ping-rapi - ping rest api
* watch-pomo-rapi - pomodoro rest api
* pomodoro-idserver - idserver

    $myip = (hostname -I).split(' ') | ?{ $_ -match '^192' }

    clear

    # Cannot attach a debugger, but can have the app auto reload during development.
    # https://github.com/dotnet/dotnet-docker/blob/master/samples/dotnetapp/dotnet-docker-dev-in-container.md
    docker run `
      --name pomo-ping-rapi `
      --rm -d `
      -p 2004:80 `
      --network pomodoro-net `
      -v ~/Repos/psgivens/PersonalTracker.Api/Ping.Api/src/:/app/src/ `
      -v ~/Repos/psgivens/PersonalTracker.Api/Ping.Api/wwwroot/:/app/wwwroot/ `
      -v ~/Repos/psgivens/PersonalTracker.Api/Ping.Api/config/:/app/config/ `
      -v ~/Repos/psgivens/PersonalTracker.Api/Ping.Api/secrets/:/app/secrets/ `
      pomodoro-ping-rapi

    docker logs pomo-ping-rapi 

    docker container stop pomo-ping-rapi

    # Cannot attach a debugger, but can have the app auto reload during development.
    # https://github.com/dotnet/dotnet-docker/blob/master/samples/dotnetapp/dotnet-docker-dev-in-container.md
    docker run `
      --name watch-pomo-rapi `
      --rm -d `
      -p 2003:80 `
      --network pomodoro-net `
      -v ~/Repos/psgivens/PersonalTracker.Api/Pomodoro.Api/src/:/app/src/ `
      -v ~/Repos/psgivens/PersonalTracker.Api/Pomodoro.Api/wwwroot/:/app/wwwroot/ `
      -v ~/Repos/psgivens/PersonalTracker.Api/Pomodoro.Api/config/:/app/config/ `
      -v ~/Repos/psgivens/PersonalTracker.Api/Pomodoro.Api/secrets/:/app/secrets/ `
      pomodoro-watch-rapi

    docker logs watch-pomo-rapi 

    docker container stop watch-pomo-rapi
    
    # Does not currently work
    docker run `
      --name pomo-rapi `
      --network pomodoro-net `
      --rm `
      -it `
      -p 5000:80 `
      -v ~/Repos/psgivens/PersonalTracker.Api/Pomodoro.Api/out/:/app/ `
      pomodoro-rapi

    # Explore the rest api container
    docker exec -it watch-pomo-rapi bash

    # Explore the watch rest api container
    docker exec -it pomo-rapi bash

    clear
    # Cannot attach a debugger, but can have the app auto reload during development.
    # https://github.com/dotnet/dotnet-docker/blob/master/samples/dotnetapp/dotnet-docker-dev-in-container.md
    docker run `
      --name pomodoro-idserver `
      --rm `
      -d `
      -p 2002:80 `
      --network pomodoro-net `
      -v ~/Repos/psgivens/PersonalTracker.Api/IdServer/src/:/app/src/ `
      -v ~/Repos/psgivens/PersonalTracker.Api/IdServer/config/:/app/config/ `
      -v ~/Repos/psgivens/PersonalTracker.Api/IdServer/secrets/:/app/secrets/ `
      pomodoro-idserver

    docker container stop pomodoro-idserver

    docker logs pomodoro-idserver

    docker exec -it pomodoro-idserver bash

# Kubernetes

I am not yet running these in Kubernetes.

### Working with Minikube

    minikube start

    minikube stop

### Working with Azure

    # See following for setup with gpg
    # https://github.com/psgivens/MiscellaneousLinux/blob/master/Desktop/.setup/tools.md

    # This will open a browser and ask you to log in. 
    az login
    
    $acrName = 'psgivens'
    
    # demonstrates that docker-credential-helpers/docker-pass-initialized-check is set
    pass init "269FEEBEE82FCE5D5CF361F398E8CFB1B84CAC37"  

    # The password doesn't matter, it just helps initialize the 'pass' system. 
    pass insert docker-credential-helpers/docker-pass-initialized-check 

    pass show docker-credential-helpers/docker-pass-initialized-check 

    pass show docker-credential-helpers

    docker-credential-pass list
    
    az acr login --name $acrName

    $acrCreds = az acr credential show `
      --name $acrName `
      --query "passwords[0].value"
    $acrCreds

Check out scripts/dockerAz.ps1 for more that you can do with Azure



